{% extends "base.html" %}

{% block title %}Sources - Event Scraper{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
    <h1>Sources</h1>
    {% if source_stats %}
    <div class="flex items-center gap-2">
        <span id="run-all-result" class="text-sm" style="display:none;"></span>
        <button id="run-all-btn" class="btn btn-primary" onclick="runAllScrapers(this)">
            Alle starten
        </button>
    </div>
    {% endif %}
</div>

<div class="card">
    {% if source_stats %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>URL</th>
                <th>Scraper</th>
                <th>Events</th>
                <th>Letzter Scrape</th>
                <th>Status</th>
                <th>Aktion</th>
            </tr>
        </thead>
        <tbody>
            {% for item in source_stats %}
            <tr>
                <td><strong>{{ item.source.name }}</strong></td>
                <td class="text-sm">
                    <a href="{{ item.source.base_url }}" target="_blank" class="text-muted">
                        {{ item.source.base_url }}
                    </a>
                </td>
                <td class="text-sm text-muted">{{ item.source.scraper_class }}</td>
                <td>{{ item.events_count }}</td>
                <td>
                    {% if item.source.last_scraped_at %}
                    {{ item.source.last_scraped_at.strftime('%d.%m.%Y %H:%M') }}
                    {% else %}
                    <span class="text-muted">Nie</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.source.is_active %}
                    <span class="badge badge-confirmed">Aktiv</span>
                    {% else %}
                    <span class="badge badge-ignored">Inaktiv</span>
                    {% endif %}
                </td>
                <td style="white-space: nowrap;">
                    {% if item.scraper_key %}
                    <button class="btn btn-sm btn-secondary"
                            onclick="runScraper(this, '{{ item.scraper_key }}')">
                        Starten
                    </button>
                    <span class="scraper-result text-sm" style="display:none; margin-left: 0.5rem;"></span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">Noch keine Sources vorhanden.</p>
    <p class="text-sm" style="margin-top: 0.5rem;">
        Führe zuerst einen Scraper aus:<br>
        <code style="background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: 4px;">
            docker compose run --rm scraper python -m src scrape mulfingen
        </code>
    </p>
    {% endif %}
</div>

<script>
async function runScraper(btn, name) {
    const resultSpan = btn.nextElementSibling;
    btn.disabled = true;
    btn.textContent = 'Läuft…';
    resultSpan.style.display = 'none';

    try {
        const resp = await fetch('/api/scraper/run', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({source_name: name})
        });
        const data = await resp.json();

        if (data.status === 'success') {
            resultSpan.textContent = `✓ ${data.events_new} neu, ${data.events_updated} aktualisiert`;
            resultSpan.style.color = 'var(--success)';
        } else {
            resultSpan.textContent = `✗ ${data.error || 'Fehler'}`;
            resultSpan.style.color = 'var(--danger)';
        }
    } catch (e) {
        resultSpan.textContent = '✗ Verbindungsfehler';
        resultSpan.style.color = 'var(--danger)';
    }

    resultSpan.style.display = '';
    btn.textContent = 'Starten';
    btn.disabled = false;
}

async function runAllScrapers(btn) {
    const resultSpan = document.getElementById('run-all-result');
    btn.disabled = true;
    btn.textContent = 'Läuft…';
    resultSpan.style.display = 'none';

    try {
        const resp = await fetch('/api/scraper/run-all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await resp.json();

        const total = data.results.length;
        const failed = data.results.filter(r => r.status !== 'success').length;
        const totalNew = data.results.reduce((s, r) => s + (r.events_new || 0), 0);

        if (failed === 0) {
            resultSpan.textContent = `✓ ${total}/${total} erfolgreich, ${totalNew} neue Events`;
            resultSpan.style.color = 'var(--success)';
        } else {
            resultSpan.textContent = `⚠ ${total - failed}/${total} erfolgreich, ${failed} Fehler, ${totalNew} neue Events`;
            resultSpan.style.color = 'var(--warning)';
        }
    } catch (e) {
        resultSpan.textContent = '✗ Verbindungsfehler';
        resultSpan.style.color = 'var(--danger)';
    }

    resultSpan.style.display = '';
    btn.textContent = 'Alle starten';
    btn.disabled = false;
}
</script>
{% endblock %}
